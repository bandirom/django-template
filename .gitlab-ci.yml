image:
  name: docker/compose:latest

services:
  - docker:19-dind

stages:
  - test
  - build

variables:
  # use overlays driver for improved performance
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""

  DOCKER_REGISTRY: ""
  DOCKER_TAG: $CI_COMMIT_REF_SLUG

  # Use Docker BuildKit for better caching and faster builds
  DOCKER_BUILDKIT: 1
  BUILDKIT_INLINE_CACHE: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

  COVERAGE_THRESHOLD: 95


formatter-check:
  image: python:3.9.9-alpine
  stage: test
  only: [branches]
  script:
    - pip install --upgrade pip flake8 black
    - cd web
    - flake8 .
    - black . --check

tests:
  only: [branches]
  stage: test
  coverage: '/TOTAL.*\s+(\d+%)$/'
  script:
    - docker-compose build
    - docker-compose run --entrypoint="" web python manage.py makemigrations --check
    - docker-compose run --entrypoint="" -u root web coverage run manage.py test
    - docker-compose run --entrypoint="" -u root web coverage report --fail-under=$COVERAGE_THRESHOLD
    - docker-compose run --entrypoint="" -u root web coverage xml
    - docker-compose run --entrypoint="" web pwd
    - docker-compose run --entrypoint="" web ls -la
    - docker cp $(docker-compose ps -q web):$(PWD)/coverage.xml .
  artifacts:
    reports:
      cobertura: coverage.xml
